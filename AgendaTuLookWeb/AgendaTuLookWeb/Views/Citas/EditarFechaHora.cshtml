@model AgendaTuLookWeb.Models.CitasModel
@{
    var servicioId = Model.Servicio.ServicioId;
}

<section id="schedule-management">
    <div class="pb-4">
        <div class="row">
            <div class="col-12">
                <h1 class="display-4">Editar fecha y hora de la cita</h1>
                <p class="text-muted">Seleccione un nuevo día y horario para el servicio.</p>
                <div class="alert alert-info">
                    <strong>Servicio seleccionado:</strong> @Model.Servicio.NombreServicio - ₡@Model.Servicio.Precio
                    @if (Model.Servicio.Precio != Model.PrecioOriginal)
                    {
                        <br />
                        <span class="@(Model.Servicio.Precio > Model.PrecioOriginal ? "text-danger" : "text-success")">
                            @(Model.Servicio.Precio > Model.PrecioOriginal ?
                                "Se generará una nueva factura por este servicio" :
                                "Se generará un reembolso por la diferencia")
                        </span>
                    }
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-6" id="calendar-container">
                <div class="bg-white rounded rounded-1 p-3">
                    <div id="calendar"></div>
                </div>
            </div>
            <div class="col-6">
                <div class="bg-white rounded rounded-1 p-3">
                    <div id="texto-guia" class="text-center text-secondary">Selecciona un día para mostrar su horarios disponibles</div>
                    <div id="selectorHoras">
                        <!-- Aquí se generarán los botones con las horas disponibles -->
                    </div>
                </div>
                <div class="mt-3">
                    <input type="hidden" id="citaId" value="@Model.CitaId" />
                    <input type="hidden" id="servicioId" value="@servicioId" />
                    <input type="hidden" id="fechaSeleccionada" />
                    <input type="hidden" id="horaSeleccionada" />
                    <a id="confirmarEdicion" onclick="redirigirConfirmarEdicion()" class="btn btn-lg btn-primary w-100" style="background-color:#321914; border-color: #1F283E;">Siguiente</a>
                </div>
            </div>
        </div>
    </div>
</section>


<script src="~/js/solicitudcita/actualizarhoraseleccionada.js"></script>
<script src="~/js/solicitudcita/calendarioEditar.js"></script>
<script src="~/js/solicitudcita/redirigiravistaeditar.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Obtener la fecha actual de la cita
        const fechaCita = '@Model.Fecha.ToString("yyyy-MM-dd")';
        const horaCita = '@Model.HoraInicio.ToString(@"hh\:mm")';

        // Si hay fecha y hora, marcarlas como seleccionadas
        if (fechaCita && horaCita) {
            document.getElementById('fechaSeleccionada').value = fechaCita;
            document.getElementById('horaSeleccionada').value = horaCita;

            // Mostrar la hora seleccionada
            mostrarHoraSeleccionada(horaCita);

            // Marcar el día en el calendario
            setTimeout(() => {
                const fechaObj = new Date(fechaCita);
                calendar.gotoDate(fechaObj);

                // Simular click en la fecha para cargar las horas disponibles
                const dayEls = document.querySelectorAll('.fc-day');
                dayEls.forEach(dayEl => {
                    const dayDate = dayEl.getAttribute('data-date');
                    if (dayDate === fechaCita) {
                        dayEl.click();
                    }
                });
            }, 500);
        }
    });

    function mostrarHoraSeleccionada(hora) {
        const selectorHoras = document.getElementById('selectorHoras');
        if (selectorHoras) {
            selectorHoras.innerHTML = `
                    <div class="alert alert-info mb-3">
                        Hora actualmente seleccionada: <strong>${hora}</strong>
                    </div>
                    <div id="horasDisponiblesContainer"></div>
                `;
        }
    }
</script>
